---
import MainLayout from '../layouts/MainLayout.astro';
import SectionHeader from '../components/SectionHeader.astro';

// Get email from environment variable
const contactEmail = import.meta.env.PUBLIC_CONTACT_EMAIL;
---

<MainLayout title="Contact">
    <SectionHeader command="./contact.sh --secure" path="contact" />

    <div class="contact-block">
        <p>> Initiating encrypted channel...</p>
    </div>

    <div class="divider">--- SECURE MESSAGE TRANSMISSION ---</div>

    <form class="cli-form" id="contact-form">
        <div class="input-group">
            <label for="email">sender_email:</label>
            <input type="email" id="email" name="email" placeholder="user@target.com" required class="cli-input" />
        </div>

        <div class="input-group">
            <label for="message">payload_content:</label>
            <textarea id="message" name="message" rows="5" placeholder="Enter message data..." required class="cli-input"></textarea>
        </div>

        <button type="submit" class="cli-btn" id="submit-btn">
            [ EXECUTE TRANSMISSION ]
        </button>

        <div id="form-status" class="status-output"></div>
    </form>

    <br /><br />

    <SectionHeader command="cat public_key.asc" path="contact" />
    <pre class="pgp-block">
-----BEGIN PGP PUBLIC KEY BLOCK-----
mQINBF... (PLACEHOLDER) ...
=KilS
-----END PGP PUBLIC KEY BLOCK-----
    </pre>
</MainLayout>

<script>
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const statusDiv = document.getElementById('form-status');
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // UI State: Loading
            const originalBtnText = submitBtn.innerText;
            submitBtn.innerText = "[ ENCRYPTING & SENDING... ]";
            submitBtn.disabled = true;
            statusDiv!.innerText = "> Establishing handshake...";

            const formData = new FormData(form);

            try {
                const response = await fetch('/api/send', {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    statusDiv!.innerHTML = '<span style="color: #00FF55">> SUCCESS: Packet delivered.</span>';
                    form.reset();
                } else {
                    const data = await response.json();
                    statusDiv!.innerHTML = `<span style="color: #FF0055">> ERROR: ${data.message || 'Transmission failed.'}</span>`;
                }
            } catch (error) {
                statusDiv!.innerHTML = '<span style="color: #FF0055">> FATAL: Network unreachable.</span>';
            } finally {
                submitBtn.innerText = originalBtnText;
                submitBtn.disabled = false;
            }
        });
    }
</script>

<style>
    .contact-block { font-size: 1.1rem; line-height: 2; margin-bottom: 2rem; }
    .contact-block a { color: var(--fg); font-weight: bold; text-decoration: none; border-bottom: 1px dotted var(--fg-dim); }
    .contact-block a:hover { background: var(--fg); color: var(--bg); }
    
    .divider { color: var(--border); font-size: 0.8rem; margin: 2rem 0; text-align: center; }

    /* Form Styles */
    .cli-form {
        border: 1px dashed var(--border);
        padding: 2rem;
        background: rgba(255,255,255,0.02);
    }

    .input-group {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
    }

    label {
        color: var(--fg-dim);
        font-family: var(--font-mono);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .cli-input {
        background: #000;
        border: 1px solid #333;
        color: var(--fg);
        font-family: var(--font-mono);
        padding: 0.8rem;
        font-size: 1rem;
        width: 100%;
        outline: none;
    }

    .cli-input:focus {
        border-color: var(--fg);
    }

    .cli-btn {
        background: transparent;
        border: 1px solid var(--fg);
        color: var(--fg);
        font-family: var(--font-mono);
        padding: 1rem 2rem;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
        transition: all 0.2s;
    }

    .cli-btn:hover:not(:disabled) {
        background: var(--fg);
        color: var(--bg);
    }

    .cli-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        border-style: dashed;
    }

    .status-output {
        margin-top: 1.5rem;
        font-family: var(--font-mono);
        min-height: 1.5rem;
    }

    .pgp-block { font-size: 0.7rem; color: var(--fg-dim); border: 1px dashed var(--border); padding: 1rem; margin-top: 1rem; }
</style>